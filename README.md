# weixin_web_emm
# 重构TODO List

## 功能改进：

### 好友模块

1. **好友删除机制**：

   当前机制：类似wechat单向删除机制，但是若A单向删B，A要重新加回B，需要通过B的申请。此时在B的视角，既可以在好友列表看到A，又同时收到了A的申请，非常的不合理。

   修改：A单向删B，重新加回B不需要向B发送申请，B自动接受。单向删除单向加回时，另一方是无感知的

2. 好友申请被通过没有通知

### 聊天模块

1. 增加消息撤回
2. 增加消息转发



## 结构改进：

1. 底层数据访问的mapper类更细致地拆分
2. 把FriendService（好友模块接口）拆分成四个接口：
   - FriendUpdateService 主要负责好友添加，好友删除等对好友数据进行增删改的业务逻辑
   - FriendQueryService 主要负责好友的查询，考虑加入neo4j后，做到部分查询接口屏蔽底层数据库（Mysql or Neo4j）
   - FriendGroupService 好友分组相关
3. ChatService 拆分
4. 将所有涉及到redis缓存读取和写入的操作封装到一个服务上，达到解耦、屏蔽底层具体缓存的作用，此外还有实现缓存失效时替代方案的作用
5. 项目包结构改为按模块划分，解耦各业务模块。
6. 消息推送代码结构重构，考虑用责任链模式写消息的处理链，这样能够让代码更清晰，方便扩展
7. 




## 性能优化

1. 消灭大于等于3个JOIN的sql语句，尽量消灭1到2个JOIN的sql语句。

2. 有大量查询都要去join user_info表：

   - 聊天记录：单聊、群聊
   - 会话列表
   - 好友列表
   - 群成员列表
   - 好友申请

   比如聊天记录，两个人的聊天会话，用户只有两个人，查询聊天记录时，每一条聊天消息都要join一次user_info表，有大量的查询是重复的。

   修改：加入缓存

   只查询出uid，然后通过缓存获取用户信息。后台维护一个用户信息的缓存

3. 聊天记录可以冗余文件信息，减少一个join

4. *chatId目前没有携带任何信息，可以通过把一些信息编码进目前的chatId方便一些对会话的基本判断*

5. *好友分组表 friend_group表可以增加字段：size表示该分组人数，使得不需要按分组获取好友时count统计*

6. 会话表（私聊会话、群聊会话）冗余最后一条消息的msgId，content，created_time，这些字段是不会被修改的，可以省掉left join

7. 分页查询聊天记录，因为前端需要知道是否还有下一页，所以后台在查询第一页的时候返回总页数，统计总页数的操作是很慢的。可以优化成：不返回总页数，而是每次查询都返回一个字段告诉前端是否还有下一页。后台实现为：每次拉取聊天记录都往前多拉取一条(pageSize+1），这样有两个好处：1、只要判断返回的条数是否大于pageSize就可以判断是否存在下一页。 2、多出来的那一条可以解决一个bug（每次拉取的边界消息无法判断时间显示）




