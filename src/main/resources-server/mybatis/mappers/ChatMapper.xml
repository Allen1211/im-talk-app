<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.allen.imsystem.dao.mappers.ChatMapper">

    <resultMap id="chatSessionDTOMap" type="com.allen.imsystem.model.dto.ChatSessionDTO">
        <result property="talkId" column="chat_id" jdbcType="BIGINT" javaType="java.lang.Long"/>
        <result property="talkTitle" column="talkTitle" />
        <result property="avatar" column="avatar" />
        <result property="lastMessage" column="content"/>
        <result property="isGroupChat" column="isGroup" jdbcType="TINYINT" javaType="java.lang.Boolean"/>
        <result property="lastMessageDate" column="created_time" />
        <result property="friendId" column="uid"/>
        <result property="gid" column="gid"/>
        <result property="lastSenderName" column="lastSenderName"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <resultMap id="privateChatInfoMap" type="com.allen.imsystem.model.pojo.PrivateChat">
        <result property="chatId" column="chat_id" jdbcType="BIGINT" javaType="java.lang.Long"/>
        <result property="uidA" column="uid_a" />
        <result property="uidB" column="uid_b" />
        <result property="userAStatus" column="user_a_status" />
        <result property="userBStatus" column="user_b_status" />
        <result property="lastMsgId" column="last_msg_id"/>
        <result property="lastSenderId" column="last_sender_id" />
        <result property="createdTime" column="created_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <resultMap id="chatGroupInfoMap" type="com.allen.imsystem.model.pojo.ChatGroup">
        <result property="groupId" column="group_id"/>
        <result property="groupName" column="group_name"/>
        <result property="ownerId" column="owner_id"/>
        <result property="avatar" column="avatar"/>
        <result property="chatId" column="chatId" jdbcType="BIGINT" javaType="java.lang.Long"/>
        <result property="status" column="status" jdbcType="TINYINT" javaType="java.lang.Boolean"/>
        <result property="createdTIme" column="created_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <resultMap id="chatNewMsgSizeMap" type="com.allen.imsystem.model.dto.ChatNewMsgSizeDTO">
        <result property="talkId" column="chat_id"/>
        <result property="size" column="new_msg_size"/>
    </resultMap>

    <resultMap id="msgRecordMap" type="com.allen.imsystem.model.dto.MsgRecord">
        <result property="messageId" column="msg_id" javaType="java.lang.Long" jdbcType="BIGINT"/>
        <result property="messageType" column="msg_type"/>
        <result property="messageText" column="content"/>
        <result property="msgTimeDate" column="created_time"/>
        <result property="messageImgUrl" column="resource_url"/>
        <result property="groupAlias" column="user_alias"/>
        <association property="userInfo" resultMap="userInfoMap"/>
        <association property="fileInfo" resultMap="fileInfoMap"/>
    </resultMap>

    <resultMap id="chatSessionInfoMap" type="com.allen.imsystem.model.dto.ChatSessionInfo">
        <result property="talkId" column="chat_id" jdbcType="BIGINT" javaType="java.lang.Long"/>
        <result property="title" column="title"/>
        <result property="srcId" column="src_id"/>
        <result property="destId" column="dest_id"/>
        <result property="isGroup" column="isGroup" javaType="java.lang.Boolean" jdbcType="TINYINT"/>
        <result property="gid" column="dest_id"/>
    </resultMap>

    <resultMap id="userInfoMap" type="com.allen.imsystem.model.dto.UserInfoDTO">
        <result property="uid" column="uid"/>
        <result property="username" column="username"/>
        <result property="avatar" column="icon_id"/>
    </resultMap>

    <resultMap id="fileInfoMap" type="com.allen.imsystem.model.dto.MsgFileInfo">
        <result property="fileName" column="file_name"/>
        <result property="downloadUrl" column="resource_url"/>
        <result property="size" column="size" javaType="java.lang.Long" jdbcType="BIGINT"/>
    </resultMap>


    <select id="selectPrivateChatList" resultMap="chatSessionDTOMap">
        (SELECT pc.chat_id, ui.username as talkTitle,ui.uid,
        CONCAT('${@com.allen.imsystem.common.Const.GlobalConst$Path@AVATAR_URL}',ui.icon_id) as avatar,
        pmr.content, pmr.created_time,pc.update_time, 0 as is_group
        FROM private_chat as pc
        LEFT JOIN user_info as ui ON pc.uid_b = ui.uid
        LEFT JOIN pri_msg_record as pmr ON pmr.msg_id = pc.last_msg_id
        WHERE (pc.uid_a = #{uid} AND pc.user_a_status=1) )
        UNION ALL
        (SELECT pc.chat_id,ui.username as talkTitle,ui.uid,
        CONCAT('${@com.allen.imsystem.common.Const.GlobalConst$Path@AVATAR_URL}',ui.icon_id) as avatar,
        pmr.content, pmr.created_time,pc.update_time, 0 as is_group
        FROM private_chat as pc
        LEFT JOIN user_info as ui ON pc.uid_a = ui.uid
        LEFT JOIN pri_msg_record as pmr ON pmr.msg_id = pc.last_msg_id
        WHERE (pc.uid_b = #{uid} AND pc.user_b_status=1) )
        ORDER BY update_time DESC
    </select>

    <select id="selectGroupChatList" resultMap="chatSessionDTOMap">
        SELECT ucg.gid,ucg.chat_id,cg.group_name as talkTitle ,ui.username as lastSenderName,cg.update_time,
        CONCAT('${@com.allen.imsystem.common.Const.GlobalConst$Path@RESOURCES_URL}',cg.avatar) as avatar,
        gmr.content, gmr.created_time, 1 as isGroup
        FROM user_chat_group as ucg
        INNER JOIN chat_group as cg ON ucg.gid = cg.gid
        LEFT JOIN user_info as ui ON cg.last_sender_id = ui.uid
        LEFT JOIN group_msg_record as gmr ON cg.last_msg_id = gmr.msg_id
        WHERE ucg.uid = #{uid} AND ucg.`should_display`=1
        ORDER BY update_time DESC
    </select>

    <select id="selectNewMsgPrivateChatData" resultMap="chatSessionDTOMap">
        SELECT pc.chat_id, ui.username,ui.uid,
        CONCAT('${@com.allen.imsystem.common.Const.GlobalConst$Path@AVATAR_URL}',ui.icon_id) as icon_id,
        pmr.content, pmr.created_time, 0 as is_group
        FROM private_chat as pc
        LEFT JOIN user_info as ui ON ui.uid = #{friendId}
        LEFT JOIN pri_msg_record as pmr ON pmr.msg_id = pc.last_msg_id
        WHERE pc.chat_id = #{chatId} AND pc.uid_a = #{uid}
        UNION ALL
        SELECT pc.chat_id, ui.username,ui.uid,
        CONCAT('${@com.allen.imsystem.common.Const.GlobalConst$Path@AVATAR_URL}',ui.icon_id) as icon_id,
        pmr.content, pmr.created_time, 0 as is_group
        FROM private_chat as pc
        LEFT JOIN user_info as ui ON ui.uid = #{friendId}
        LEFT JOIN pri_msg_record as pmr ON pmr.msg_id = pc.last_msg_id
        WHERE pc.chat_id = #{chatId} AND pc.uid_b = #{uid}
    </select>

    <select id="selectPrivateChatHistoryMsg" resultMap="msgRecordMap">
        SELECT msg_id , msg_type, content,
        CONCAT('${@com.allen.imsystem.common.Const.GlobalConst$Path@RESOURCES_URL}',fm.url) as resource_url,
        fm.file_name , fm.size, mr.created_time ,ui.uid, ui.username,
        CONCAT('${@com.allen.imsystem.common.Const.GlobalConst$Path@AVATAR_URL}',ui.icon_id) as icon_id
        FROM pri_msg_record as mr
        INNER JOIN user_info as ui ON ui.uid = mr.from_uid
        LEFT JOIN file_msg_md5 as fm ON mr.file_md5 = fm.md5
        WHERE mr.chat_id = #{chatId} AND mr.created_time &lt; #{beginTime}
        ORDER BY mr.created_time DESC
        LIMIT #{pageBean.from},#{pageBean.offset}
    </select>

    <select id="selectGroupChatHistoryMsg" resultMap="msgRecordMap">
        SELECT gmr.msg_id,gmr.msg_type,gmr.content,gmr.created_time,
        fm.file_name,fm.size,
        CONCAT('${@com.allen.imsystem.common.Const.GlobalConst$Path@RESOURCES_URL}',fm.url) as resource_url,
        ucg.user_alias,
        ui.uid,ui.username,
        CONCAT('${@com.allen.imsystem.common.Const.GlobalConst$Path@AVATAR_URL}',ui.icon_id) as icon_id
        FROM user_chat_group as ucg
        INNER JOIN group_msg_record as gmr ON gmr.gid = ucg.gid
        LEFT JOIN user_info as ui ON ui.uid = gmr.sender_id
        LEFT JOIN file_msg_md5 fm ON fm.md5 = gmr.file_md5
        WHERE ucg.chat_id = #{chatId} AND gmr.created_time &lt; #{beginTime}
        ORDER BY gmr.created_time DESC
        LIMIT #{pageBean.from},#{pageBean.offset}
    </select>

    <select id="selectPrivateChatInfoByUid" resultMap="privateChatInfoMap">
        SELECT * FROM private_chat WHERE uid_a=#{uidA} AND uid_b=#{uidB} LIMIT 1
    </select>


    <select id="selectPrivateChatInfoByChatId" resultMap="privateChatInfoMap">
        SELECT * FROM private_chat WHERE chat_id = #{chatId} LIMIT 1
    </select>

    <select id="countPrivateChatUnReadMsgForUser" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM pri_msg_record WHERE chat_id = #{chatId} AND to_uid = #{uid} AND has_read=0
    </select>

    <select id="selectPrivateChatData" resultMap="chatSessionInfoMap">
        SELECT pc.chat_id,pc.uid_a as dest_id,pc.uid_b as src_id ,ui.username as title,0 as isGroup FROM private_chat as pc
        INNER JOIN user_info as ui ON ui.uid = pc.uid_a
        WHERE chat_id=#{chatId} AND uid_b = #{uid}
        UNION ALL
        SELECT pc.chat_id,pc.uid_b as dest_id,pc.uid_a as src_id,ui.username as title,0 as isGroup FROM private_chat as pc
        INNER JOIN user_info as ui ON ui.uid = pc.uid_b
        WHERE chat_id=#{chatId} AND pc.uid_a = #{uid}
        LIMIT 1
    </select>

    <select id="selectGroupChatData" resultMap="chatSessionInfoMap">
        SELECT ucg.chat_id,ucg.gid as dest_id,cg.owner_id as src_id,1 as isGroup, group_name as title
        FROM user_chat_group as ucg
        INNER JOIN chat_group as cg ON ucg.gid = cg.gid
        WHERE ucg.chat_id = #{chatId}
        LIMIT 1
    </select>


    <select id="selectPrivateChatNewMsgSize" resultMap="chatNewMsgSizeMap">
        SELECT chat_id, COUNT(*) as new_msg_size FROM pri_msg_record WHERE to_uid=#{uid} AND has_read=0
        AND chat_id in
        <foreach item="chat" index="index" collection="chatList" open="(" separator="," close=")">
            #{chat.talkId}
        </foreach>
        GROUP BY chat_id
    </select>

    <select id="selectPrivateChatTitleName" resultType="java.lang.String">
        SELECT username FROM private_chat as pc
        INNER JOIN user_info as ui ON ui.uid = pc.uid_a
        WHERE chat_id=#{chatId} AND uid_b = #{uid}
        UNION ALL
        SELECT username FROM private_chat as pc
        INNER JOIN user_info as ui ON ui.uid = pc.uid_b
        WHERE chat_id=#{chatId} AND uid_a = #{uid}
        LIMIT 1
    </select>

    <select id="selectChatGroupInfoByChatId" resultMap="chatGroupInfoMap">
        SELECT * FROM chat_group WHERE chat_id = #{chatId} AND status=1
    </select>


    <select id="countAllPrivateHistoryMsg" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM pri_msg_record
        WHERE chat_id = #{chatId} AND status = 1 AND created_time &lt; #{beginTime}
    </select>

    <select id="countAllGroupHistoryMsg" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM group_msg_record as gmr
        INNER JOIN user_chat_group as ucg ON ucg.gid = gmr.gid
        WHERE ucg.chat_id = #{chatId} AND gmr.`status` = 1 AND gmr.created_time &lt; #{beginTime}
    </select>


    <insert id="insertNewPrivateChat" parameterType="com.allen.imsystem.model.pojo.PrivateChat">
        INSERT INTO private_chat (chat_id, uid_a, uid_b, user_a_status, user_b_status, last_msg_id,last_sender_id, created_time, update_time)
        VALUES (#{chatId},#{uidA},#{uidB},#{userAStatus},#{userBStatus},#{lastMsgId},#{lastSenderId},NOW(),NOW())
    </insert>


<!--    INSERT INTO pri_msg_record (msg_id, msg_type, chat_id, from_uid, to_uid, content,resource_url, has_read, status)-->
<!--    values (#{msgId},#{msgType},#{chatId},#{fromUid},#{toUid},#{content},#{resourceUrl},#{hasRead},#{status})-->

    <!--插入一条私聊消息到私聊消息记录    -->
    <insert id="insertPrivateMsgToRecord" parameterType="com.allen.imsystem.model.pojo.PrivateMsgRecord" >
          INSERT INTO `pri_msg_record` (
        <trim suffixOverrides=",">
            <if test="msgId!=null">msg_id,</if>
            <if test="msgType!=null">msg_type,</if>
            <if test="chatId!=null">chat_id,</if>
            <if test="fromUid!=null">from_uid,</if>
            <if test="toUid!=null">to_uid,</if>
            <if test="content!=null">content,</if>
            <if test="fileMd5!=null">file_md5,</if>
            <if test="hasRead!=null">has_read,</if>
            <if test="status!=null">status,</if>
        </trim>)
        VALUES (
        <trim suffixOverrides=",">
            <if test="msgId!=null">#{msgId},</if>
            <if test="msgType!=null">#{msgType},</if>
            <if test="chatId!=null">#{chatId},</if>
            <if test="fromUid!=null">#{fromUid},</if>
            <if test="toUid!=null">#{toUid},</if>
            <if test="content!=null">#{content},</if>
            <if test="fileMd5!=null">#{fileMd5},</if>
            <if test="hasRead!=null">#{hasRead},</if>
            <if test="status!=null">#{status},</if>
        </trim>)
    </insert>

    <update id="updatePrivateChat" parameterType="com.allen.imsystem.model.pojo.PrivateChat">
        UPDATE private_chat
        <set>
            <if test="chatId!=null">chat_id=#{chatId},</if>
            <if test="uidA!=null">uid_a=#{uidA},</if>
            <if test="uidB!=null">uid_b=#{uidB},</if>
            <if test="userAStatus!=null">user_a_status=#{userAStatus},</if>
            <if test="userBStatus!=null">user_b_status=#{userBStatus},</if>
            <if test="lastMsgId!=null">last_msg_id=#{lastMsgId},</if>
            <if test="lastSenderId!=null">last_sender_id=#{lastSenderId},</if>
            <if test="createdTime!=null">created_time=#{createdTime},</if>
            <if test="updateTime!=null">update_time=#{updateTime}</if>
        </set>
        WHERE chat_id=#{chatId}
    </update>

    <update id="updatePrivateChatLastMsg" >
        UPDATE private_chat SET last_msg_id = #{msgId} ,last_sender_id = #{lastSenderId}, update_time=NOW()
        WHERE chat_id = #{chatId}
    </update>

<!--    更新某一会话的所有聊天记录-->
    <update id="updatePrivateMsgRecordByChatId">
        UPDATE msg_record
        <set>
            <if test="hasRead!=null">has_read=#{hasRead},</if>
            <if test="status!=null">status=#{status},</if>
            <if test="updateTime!=null">update_time=#{updateTime},</if>
        </set>
        WHERE chat_id=#{chatId}
    </update>

<!--    标记所有某私聊所有信息已读-->
    <update id="setAllPrivateChatMsgHasRead">
        UPDATE pri_msg_record SET has_read = 1 WHERE chat_id=#{chatId} AND to_uid=#{uid}
    </update>

    <delete id="hardDeletePrivateChat">
        DELETE FROM private_chat WHERE uid_a=#{uidA} AND uid_b=#{uidB}
    </delete>



<!--    测试用-->
    <select id="selectChatSessionLastMsgTime" resultType="com.allen.imsystem.model.dto.ChatLastMessageTime">
        SELECT cs.chat_id as chatId,r.created_time as lastMsgTime FROM private_chat as cs LEFT JOIN pri_msg_record as r ON cs.last_msg_id = r.msg_id
    </select>

    <select id="fixSelect" resultType="com.allen.imsystem.model.FixBean">
        SELECT pmr.chat_id as chatId,msg_id as msgId,pc.uid_a as toUid from pri_msg_record as pmr
        LEFT JOIN private_chat as pc
        ON pmr.chat_id = pc.chat_id
        WHERE pc.uid_b=pmr.from_uid

        UNION ALL

        SELECT pmr.chat_id as chatId,msg_id as msgId, pc.uid_b as toUid from pri_msg_record as pmr
        LEFT JOIN private_chat as pc
        ON pmr.chat_id = pc.chat_id
        WHERE pc.uid_a=pmr.from_uid

        ORDER BY msgId
    </select>

    <update id="fix" parameterType="java.util.List">
        <foreach collection="fixBeanList" item="fixBean" index="index" open="" close="" separator=";">
            update pri_msg_record
            <set>
                to_uid=${fixBean.toUid}
            </set>
            where msg_id = ${fixBean.msgId} AND chat_id = ${fixBean.chatId}
        </foreach>
    </update>
</mapper>